<?php// e.g. url:"page.php?upload=true" as handler property//print_r($_SERVER);define("IMAGEHASH", 'as98dasd2b23f32fu21gf8712gf');require_once 'ext/thumb/ThumbLib.inc.php';require_once 'class/Category.php';require_once 'class/Product.php';require_once 'functions.php';$act = $_GET['act'];$tmp_dir = '../products/tmp/';$p = new Product();$category = new Category();if (// basic checks        isset(                $_SERVER['CONTENT_TYPE'],                 $_SERVER['CONTENT_LENGTH'],                 $_SERVER['HTTP_X_FILE_NAME']) &&        $_SERVER['CONTENT_TYPE'] == 'multipart/form-data' &&        (isset($_GET['category']) && $_GET['category'] != '') &&        $act == 'upload') {    // create the object and assign property    /* $file = new stdClass;      $file->name = basename($_SERVER['HTTP_X_FILE_NAME']);      $file->size = $_SERVER['HTTP_X_FILE_SIZE'];      $file->content = file_get_contents("php://input");      // if everything is ok, save the file somewhere      if(file_put_contents('files/'.$file->name, $file->content))      echo "OK"; */    $cat_id = $_GET['category'];    $data = $category->getCategoryById($cat_id);    $upload_dir = '../products/'.$data[0]['name'].'/';    $fileName = basename($_SERVER['HTTP_X_FILE_NAME']);    if (file_exists($upload_dir . $fileName)) {        $fileName = uniqid() . $fileName;    }    $input = fopen('php://input', 'rb');    $file = fopen($tmp_dir . $fileName, 'wb');    stream_copy_to_stream($input, $file);    fclose($input);    fclose($file);    $file_type = get_file_type($tmp_dir . $fileName);    // Make thumb    $thumb_width = 200;    $file_dir = $tmp_dir . $fileName;    try     {        $result = null;        if($file_type == 'image') {          $thumb_name = sha1(IMAGEHASH.$fileName).$fileName;          $thumb = PhpThumbFactory::create($file_dir);          $thumb->resize($thumb_width);          $thumb->save($tmp_dir.$thumb_name);          $result = array(              'file'=>$tmp_dir . $fileName,              'thumb'=>$tmp_dir.$thumb_name,              'filename'=>$fileName,              'thumbname'=>$thumb_name,              'filetype'=>get_file_type($tmp_dir.$fileName),              'element'=>show_file($tmp_dir.$fileName)          );        } else if($file_type == 'video') {             $result = array(              'file'=>$tmp_dir . $fileName,              'thumb'=>$tmp_dir.$fileName,              'filename'=>$fileName,              'thumbname'=>$fileName,              'filetype'=>get_file_type($tmp_dir.$fileName),              'element'=>show_file($tmp_dir.$fileName)          );        }          echo json_encode($result);     }     catch (Exception $e)     {          echo 'error';     }   // echo $upload_dir . $fileName;} else if($act=='add') {    $id = (isset($_GET['id'])?$_GET['id']:0);    $name = $_GET['name'];    $des = $_GET['description'];    $order =$_GET['order'];    $file = $_GET['file'];    $thumb = $_GET['thumb'];    $cat = $_GET['category'];	$feature = isset($_GET['feature']) ? $_GET['feature'] : 0;	print_r($_GET['feature']);    $result = null;    $data = $p->getProductById($id);    $catname = $category->getCategoryById($cat);    $catname = $catname[0]['name'];    $upload_dir = PRODUCTS_DIR.$catname.'/';    $upload_thumb_dir = PRODUCTS_DIR.$catname.'/thumb/';    $tmp_file = $tmp_dir.$file;    $tmp_thumb = $tmp_dir.$thumb;    if(file_exists(PRODUCTS_DIR.'tmp/'.$file))        rename(PRODUCTS_DIR.'tmp/'.$file,$upload_dir.$file);    if(file_exists(PRODUCTS_DIR.'tmp/'.$thumb))        rename(PRODUCTS_DIR.'tmp/'.$thumb,$upload_thumb_dir.$thumb);    if(isset($data[0])){        $d =$data[0];        $old_file = $d['file'];        $old_thumb = $d['thumb'];         $result= $p->updateProductById($id,array(            'name'=>$name,            'description'=>$des,            'order'=>$order,            'file'=>$file,            'thumb'=>$thumb,            'category_id'=>$cat,			'feature' => $feature        ));        if($result>0){        if(file_exists('../products/'.$catname.'/thumb/'.$old_thumb) && $old_thumb != $thumb)              unlink('../products/'.$catname.'/thumb/'.$old_thumb);        if(file_exists('../products/'.$catname.'/'.$old_file) && $old_file != $file)            unlink('../products/'.$catname.'/'.$old_file);        }    } else {        $result= $p->insert(array(            'name'=>$name,            'description'=>$des,            'order'=>$order,            'file'=>$file,            'thumb'=>$thumb,            'category_id'=>$cat,			'feature' => $feature        ));    }       if($result>=0){        if($id==0)            echo $p->lastId();        else            echo $id;    } else {        echo '-1';    }    } else if($act=='edit') {     $id = (isset($_GET['id'])?$_GET['id']:0);     if($id > 0 ){        $name = $_GET['name'];        $des = $_GET['description'];        $order =$_GET['order'];        $file = $_GET['file'];        $thumb = $_GET['thumb'];        $cat = $_GET['category'];		$feature = isset($_GET['feature']) ? $_GET['feature'] : 0;        $result= $p->insert(array(            'name'=>$name,            'description'=>$des,            'order'=>$order,            'file'=>$file,            'thumb'=>$thumb,            'category_id'=>$cat,			'feature' => $feature        ));        return $result;     }    } else if($act=='delete') {     $id = (isset($_GET['id'])?$_GET['id']:0);    echo $p->delete($id);    } else {    // if there is an error this will be the output instead of "OK"    echo "Error";}die();?>